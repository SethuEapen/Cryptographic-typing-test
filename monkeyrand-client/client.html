<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Instance Page</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  </head>
  <body>
    <h1>Instance</h1>
    <label>Instance ID: <input id="iid" placeholder="abc-123" /></label>
    <br/>
    <label>Text value: <input id="val" placeholder="type something"/></label>
    <p>Status: <span id="status">disconnected</span></p>

    <script>
      const statusEl = document.getElementById("status");
      const iidEl = document.getElementById("iid");
      const valEl = document.getElementById("val");

      // Connect when instanceId is set
      let socket;
      iidEl.addEventListener("change", () => {
        if (socket) socket.disconnect();
        socket = io("http://localhost:3000", { transports: ["websocket"] });
        socket.on("connect", () => {
          statusEl.textContent = "connected";
          socket.emit("register", iidEl.value.trim());
        });
        socket.on("disconnect", () => statusEl.textContent = "disconnected");

        // Handle RPC requests from server
        socket.on("rpc:request", ({ requestId, event }) => {
          if (event === "getData") {
            const payload = { value: valEl.value };
            socket.emit("rpc:response", { requestId, payload });
          } else {
            socket.emit("rpc:response", { requestId, error: `Unknown event ${event}` });
          }
        });
      });
    </script>
  </body>
</html>
